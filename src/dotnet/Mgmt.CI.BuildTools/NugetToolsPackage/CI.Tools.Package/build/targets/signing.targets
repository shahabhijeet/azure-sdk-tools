<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Label="DelaySignVerification properties">
    <OnPremiseTargetsFile>$(CISignRepo)\tools\sdkbuildtools\targets\onPremise.targets</OnPremiseTargetsFile>
  </PropertyGroup>

  <PropertyGroup Label="Policheck Properties">
    <DebugMessageImp>Low</DebugMessageImp>
    <PolicheckScanDir>$(ScopeScanPath)</PolicheckScanDir>
  </PropertyGroup>

  <Target Name="PreSignBinariesDependsOn">
    <ItemGroup>
      <PolicheckScanDir Include="@(FilesToSign)" />
    </ItemGroup>
     <PropertyGroup>      
      <ScopeScanPath Condition=" '$(Scope)' != 'All' ">$(ProjectRootDir)</ScopeScanPath>
      <ScopeScanPath Condition=" '$(ScopeScanPath)' == '' AND '$(Scope)' != 'All' ">$(LibrarySourceFolder)\$(Scope.TrimEnd('\'))</ScopeScanPath>
      <ScopeScanPath Condition=" '$(ScopeScanPath)' == '' AND '$(Scope)' != 'All' ">$(LibraryRoot)\$(Scope.TrimEnd('\'))</ScopeScanPath>
      <PolicheckScanDir Condition=" Exists($(ScopeScanPath))">$(ScopeScanPath)</PolicheckScanDir>
    </PropertyGroup>
  </Target>
  <Target Name="PreSignBinaries" DependsOnTargets="PreSignBinariesDependsOn" Condition=" '$(CodeSign)' == 'true' AND '$(Configuration)' == 'Release' ">
    <Message Text="DelaySignedFileItems ....... @(DelaySignedFileItems)" Importance="$(DebugMessageImp)" />
    <CallTarget Targets="PoliCheckTarget" RunEachTargetSeparately="true" />
    <Message Text="Done executing PreSign Target" Importance="$(DebugMessageImp)" />
  </Target>

  <Target Name="SignBinariesDependsOn">
    <Message Text="UnsignedFileItems ....... @(FilesToSign)" Importance="$(DebugMessageImp)" />
    <ItemGroup>
      <UnsignedFileItems Include="@(FilesToSign)" />
    </ItemGroup>
     <PropertyGroup>
      <UseSourceDirAsSignDir>false</UseSourceDirAsSignDir>
      <CopySignedFilesToOriginalLoc>true</CopySignedFilesToOriginalLoc>
      <SignOperationLogDir>$(BinariesFolder)</SignOperationLogDir>
    </PropertyGroup>
  </Target>

  <Target Name="SignBinaries" DependsOnTargets="SignBinariesDependsOn" Condition=" '$(CodeSign)' == 'true' AND '$(Configuration)' == 'Release' ">
    <Message Text="ProjectFile .... $(OnPremiseTargetsFile)" Importance="$(DebugMessageImp)" />
    <CallTarget Targets="AuthenticodeSignBinariesTarget" RunEachTargetSeparately="true" />
    <Message Text="Done executing Sign Target" Importance="$(DebugMessageImp)" />
  </Target>

  <Target Name="PostSignBinariesDependsOn">
    <ItemGroup>
      <DelaySignedFileItems Include="@(FilesToSign)" />
    </ItemGroup>
  </Target>
  <Target Name="PostSignBinaries" DependsOnTargets="PostSignBinariesDependsOn" Condition=" '$(CodeSign)' == 'true' ">
    <Message Text="DelaySignedFileItems ....... @(DelaySignedFileItems)" Importance="$(DebugMessageImp)" />
    <CallTarget Targets="VerifyAssemblyPublicTokenTarget" RunEachTargetSeparately="true" />
    <Message Text="Done executing PreSign Target" Importance="$(DebugMessageImp)" />
  </Target>

  <Target Name="SignNugetPackageDependsOn">
    <Message Text="BuiltPackageOutputDir ....... @(BuiltPackageOutputDir)" Importance="$(DebugMessageImp)" />
    <PropertyGroup>
      <UnsignedNupkgsDir>$(BuiltPackageOutputDir)</UnsignedNupkgsDir>
      <UseSourceDirAsSignNupkgsDir>false</UseSourceDirAsSignNupkgsDir>
      <CopySignedNupkgsToOriginalLoc>true</CopySignedNupkgsToOriginalLoc>
      <SignOperationLogDir>$(BinariesFolder)</SignOperationLogDir>
    </PropertyGroup>
  </Target>
  <Target Name="SignNugetPackage" DependsOnTargets="SignNugetPackageDependsOn" 
          Condition=" '$(CodeSign)' == 'true' AND '$(Configuration)' == 'Release' AND '$(SkipAuthSign)' != 'true' ">
    <CallTarget Targets="AuthenticodeSignNugetTarget" />
    <Message Text="Done executing Signing Nuget Packages" Importance="$(DebugMessageImp)" />
  </Target>

  <Target Name="RunSignTargets" Condition=" '$(CodeSign)' == 'true' 
        AND '$(SkipAuthSign)' != 'true' 
        AND '$(Configuration)' == 'Release' "
        DependsOnTargets="SignBinaries" />
  
  <Import Condition=" Exists('$(CISignRepo)') " Project="$(CISignRepo)\tools\sdkbuildtools\targets\onPremise.targets" />
</Project>